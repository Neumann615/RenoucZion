# 解析器

在上一章中，我们初步讨论了解析器（parser）的工作原理，知
道了解析器本质上是一个状态机。但我们也曾提到，正则表达式其实
也是一个状态机。因此在编写 parser 的时候，利用正则表达式能够
让我们少写不少代码。本章我们将更多地利用正则表达式来实现
HTML 解析器。另外，一个完善的 HTML 解析器远比想象的要复杂。
我们知道，浏览器会对 HTML 文本进行解析，那么它是如何做的呢？
其实关于 HTML 文本的解析，是有规范可循的，即 WHATWG 关于
HTML 的解析规范，其中定义了完整的错误处理和状态机的状态迁移
流程，还提及了一些特殊的状态，例如 DATA、CDATA、RCDATA、
RAWTEXT 等。那么，这些状态有什么含义呢？它们对解析器有哪些影
响呢？什么是 HTML 实体，以及 Vue.js 模板解析器需要如何处理
HTML 实体呢？这些问题都会在本章中讨论。

## 文本模式及其对解析器的影响

文本模式指的是解析器在工作时所进入的一些特殊状态，在不同的特殊状态下，解析器对文本的解析行为会有所不同。
具体来说，当解析器遇到一些特殊标签时，会切换模式，从而影响其对文本的解析行为。这些特殊标签是：

- `<title>` 标签、`<textarea>` 标签，当解析器遇到这两个标签时，会切换到 RCDATA 模式；

- `<style>`、`<xmp>`、`<iframe>`、`<noembed>`、`<noframes>`、`<noscript>` 等标签，当解析器遇到这些标签时，会切换到RAWTEXT 模式；

- 当解析器遇到 <![CDATA[ 字符串时，会进入 CDATA 模式。

解析器的初始模式则是 DATA 模式。对于 Vue.js 的模板 DSL 来说，模板中不允许出现 `<script>` 标签，因此 Vue.js 模板解析器在遇到
`<script>` 标签时也会切换到 RAWTEXT 模式。

解析器的行为会因工作模式的不同而不同。WHATWG 规范的第 13.2.5.1 节给出了初始模式下解析器的工作流程，如下图所示。

![avatar](/Vue/images/第544页-150.png)

544